{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>{{ experience.title }} ‚Äì Python AR Experience</title>
  
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #000;
      overflow: hidden;
    }
    
    .camera-container {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      background: #000;
      z-index: 1;
    }
    
    #cameraVideo {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    #processingCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    
    .camera-controls {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1001;
      display: flex;
      gap: 15px;
    }
    
    .btn {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    }
    
    .ar-status {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1002;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px 15px;
      border-radius: 10px;
      font-size: 14px;
      backdrop-filter: blur(10px);
    }
    
    .dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .dot.ready { background: #ffc107; }
    .dot.active { background: #47f413ff; }
    .dot.error { background: #dc3545; }
  </style>
</head>
<body>
  <div class="ar-status">
    <div>üéØ <strong>{{ experience.title }}</strong></div>
    <div><span id="stream-dot" class="dot ready"></span>Stream: <span id="stream-status">Ready</span></div>
    <div><span id="ar-dot" class="dot ready"></span>AR: <span id="ar-status">Standby</span></div>
  </div>
  
  <div id="camera-container" class="camera-container">
    <video id="cameraVideo" autoplay muted playsinline></video>
    <canvas id="processingCanvas"></canvas>
  </div>
  
  <div class="camera-controls">
    <button id="startCamera" class="btn">üìπ Start Camera</button>
    <button id="stopCamera" class="btn" style="display:none;">‚èπÔ∏è Stop Camera</button>
    <button id="switchCamera" class="btn">üîÑ Switch</button>
    <button id="playVideo" class="btn" style="background: #ff4444;">üé¨ Play Video</button>
  </div>
  
  <script>
    const $ = (id) => document.getElementById(id);
    window.AR_CONFIG = { slug: '{{ experience.slug }}' };
    const CONFIG = window.AR_CONFIG;
    
    console.log('üéØ AR Config loaded:', CONFIG);
    
    function setStatus(type, message, state) {
      const statusEl = $(`${type}-status`);
      const dotEl = $(`${type}-dot`);
      if (statusEl) statusEl.textContent = message;
      if (dotEl) dotEl.className = `dot ${state}`;
    }
    
    class ARVideoSystem {
      constructor() {
        this.video = null;
        this.canvas = null;
        this.ctx = null;
        this.stream = null;
        this.isProcessing = false;
        this.frameCount = 0;
        this.overlayVideo = null;
        this.videoOverlayActive = false;
        this.userHasInteracted = false;
        this.facingMode = 'environment';
        this.videoTriggered = false;
      }
      
      async init() {
        this.video = $('cameraVideo');
        this.canvas = $('processingCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.canvas.width = 640;
        this.canvas.height = 480;
        
        document.addEventListener('click', () => this.userHasInteracted = true, { once: true });
        document.addEventListener('touchstart', () => this.userHasInteracted = true, { once: true });
        
        this.createOverlayVideo();
      }
      
      createOverlayVideo() {
        this.overlayVideo = document.createElement('video');
        this.overlayVideo.muted = true;
        this.overlayVideo.loop = true;
        this.overlayVideo.playsInline = true;
        this.overlayVideo.setAttribute('webkit-playsinline', 'true');
        this.overlayVideo.style.display = 'none';
        this.overlayVideo.src = '{{ experience.video.url }}' || 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4';
        document.body.appendChild(this.overlayVideo);
        
        this.overlayVideo.oncanplay = () => console.log('üìπ Video ready to play');
        this.overlayVideo.onplay = () => {
          console.log('‚úÖ Video started playing');
          this.videoOverlayActive = true;
        };
        this.overlayVideo.onended = () => {
          console.log('üîÑ Video ended, restarting...');
          this.overlayVideo.currentTime = 0;
          this.overlayVideo.play();
        };
      }
      
      async startCamera() {
        try {
          setStatus('stream', 'Starting...', 'ready');
          
          const constraints = {
            video: {
              facingMode: this.facingMode,
              width: { ideal: 640 },
              height: { ideal: 480 }
            },
            audio: false
          };
          
          this.stream = await navigator.mediaDevices.getUserMedia(constraints);
          this.video.srcObject = this.stream;
          
          this.video.onloadedmetadata = () => {
            this.canvas.width = this.video.videoWidth;
            this.canvas.height = this.video.videoHeight;
            this.startProcessing();
          };
          
          $('startCamera').style.display = 'none';
          $('stopCamera').style.display = 'inline-block';
          
          setStatus('stream', 'Active', 'active');
          console.log('üìπ Camera started');
          
        } catch (error) {
          console.error('Camera error:', error);
          setStatus('stream', 'Error', 'error');
        }
      }
      
      stopCamera() {
        if (this.stream) {
          this.stream.getTracks().forEach(track => track.stop());
          this.stream = null;
        }
        
        this.isProcessing = false;
        this.stopVideoOverlay();
        
        $('startCamera').style.display = 'inline-block';
        $('stopCamera').style.display = 'none';
        
        setStatus('stream', 'Stopped', 'ready');
        setStatus('ar', 'Standby', 'ready');
        console.log('‚èπÔ∏è Camera stopped');
      }
      
      switchCamera() {
        this.facingMode = this.facingMode === 'environment' ? 'user' : 'environment';
        if (this.stream) {
          this.stopCamera();
          setTimeout(() => this.startCamera(), 500);
        }
      }
      
      startProcessing() {
        this.isProcessing = true;
        this.frameCount = 0;
        setStatus('ar', 'Scanning...', 'ready');
        this.processFrame();
      }
      
      async processFrame() {
        if (!this.isProcessing || !this.video) return;
        
        this.frameCount++;
        
        this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
        
        if (this.videoOverlayActive && this.overlayVideo) {
          this.drawVideoOverlay();
        }
        
        if (this.frameCount % 5 === 0) {
          await this.sendFrameToServer();
        }
        
        requestAnimationFrame(() => this.processFrame());
      }
      
      drawVideoOverlay() {
        if (!this.overlayVideo || this.overlayVideo.paused || this.overlayVideo.readyState < 2) {
          return;
        }
        
        const canvasWidth = this.canvas.width;
        const canvasHeight = this.canvas.height;
        const videoWidth = 320;
        const videoHeight = 240;
        const x = (canvasWidth - videoWidth) / 2;
        const y = (canvasHeight - videoHeight) / 2;
        
        this.ctx.save();
        this.ctx.globalAlpha = 0.9;
        this.ctx.drawImage(this.overlayVideo, x, y, videoWidth, videoHeight);
        this.ctx.restore();
        
        this.ctx.strokeStyle = 'transparent';
        this.ctx.lineWidth = 3;
        this.ctx.strokeRect(x, y, videoWidth, videoHeight);
      }
      
      async attemptVideoPlay() {
        if (!this.overlayVideo) {
          console.log('‚ùå No overlay video element');
          return;
        }
        
        if (this.videoOverlayActive) {
          console.log('‚úÖ Video already playing');
          return;
        }
        
        console.log('üé¨ Attempting to play video...', {
          readyState: this.overlayVideo.readyState,
          paused: this.overlayVideo.paused,
          muted: this.overlayVideo.muted
        });
        
        try {
          this.overlayVideo.muted = true;
          this.overlayVideo.volume = 0;
          
          await this.overlayVideo.play();
          console.log('‚úÖ Video autoplay successful');
          this.videoOverlayActive = true;
          
        } catch (error) {
          console.log('‚ùå Autoplay blocked:', error.name, error.message);
          this.showClickToPlay();
        }
      }
      
      showClickToPlay() {
        const existing = document.getElementById('click-overlay');
        if (existing) existing.remove();
        
        const overlay = document.createElement('div');
        overlay.id = 'click-overlay';
        overlay.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0,0,0,0.9);
          color: white;
          padding: 30px;
          border-radius: 15px;
          text-align: center;
          z-index: 10000;
          cursor: pointer;
          
        `;
        
        overlay.innerHTML = `
          <div style="font-size: 24px; margin-bottom: 10px;">üéØ AR Video Ready</div>
          <div style="font-size: 16px;">Tap to play video overlay</div>
        `;
        
        overlay.onclick = async () => {
          try {
            console.log('üëÜ User clicked to play video');
            this.overlayVideo.muted = true;
            await this.overlayVideo.play();
            this.videoOverlayActive = true;
            overlay.remove();
            console.log('‚úÖ Manual video play successful');
          } catch (e) {
            console.error('‚ùå Manual play failed:', e);
            alert('Video failed to play: ' + e.message);
          }
        };
        
        document.body.appendChild(overlay);
        
        setTimeout(() => {
          if (overlay.parentNode) overlay.remove();
        }, 10000);
      }
      
      stopVideoOverlay() {
        if (this.overlayVideo) {
          this.overlayVideo.pause();
          this.overlayVideo.currentTime = 0;
          this.videoOverlayActive = false;
        }
      }
      

      
      async sendFrameToServer() {
        if (!this.video || !this.isProcessing) return;
        
        try {
          const tempCanvas = document.createElement('canvas');
          tempCanvas.width = 640;
          tempCanvas.height = 480;
          const tempCtx = tempCanvas.getContext('2d');
          tempCtx.drawImage(this.video, 0, 0, 640, 480);
          
          const imageData = tempCanvas.toDataURL('image/jpeg', 0.8);
          
          const response = await fetch(`/api/process-ar-frame/${CONFIG.slug}/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              frame: imageData,
              frame_count: this.frameCount,
              timestamp: Date.now()
            })
          });
          
          if (response.ok) {
            const result = await response.json();
            const confidence = result.confidence_percent || 0;
            
            console.log('üîç Detection Result:', {
              confidence: confidence,
              threshold: 65
            });
            
            if (confidence >= 65 && !this.videoTriggered) {
              setStatus('ar', `MARKER DETECTED (${confidence}%)`, 'active');
              console.log('‚úÖ 65% THRESHOLD MET - Playing video');
              this.videoTriggered = true;
              await this.attemptVideoPlay();
            } else if (confidence >= 65) {
              setStatus('ar', `MARKER DETECTED (${confidence}%)`, 'active');
            } else {
              setStatus('ar', `Scanning... (${confidence}%)`, 'ready');
            }
          }
          
        } catch (error) {
          console.error('Processing error:', error);
        }
      }
    }
    
    let arSystem = null;
    
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        arSystem = new ARVideoSystem();
        await arSystem.init();
        
        $('startCamera').onclick = () => arSystem.startCamera();
        $('stopCamera').onclick = () => arSystem.stopCamera();
        $('switchCamera').onclick = () => arSystem.switchCamera();
        $('playVideo').onclick = () => {
          console.log('üëÜ Manual video play triggered');
          arSystem.attemptVideoPlay();
        };
        

        
        console.log('üéØ AR System Ready - Use Play Video button');
        
      } catch (error) {
        console.error('Initialization failed:', error);
        setStatus('ar', 'Error', 'error');
      }
    });
  </script>
</body>
</html>