{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
    <title>{{ title|default:experience.title }} - AR Experience</title>
    
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar-nft.min.js"></script>
    
    <style>
        body { margin: 0; font-family: Arial, sans-serif; overflow: hidden; }
        #arjs-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        
        #start-ar {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #00ff00; color: black; padding: 20px 40px;
            border: none; border-radius: 10px; font-size: 18px; font-weight: bold;
            cursor: pointer; z-index: 1000;
        }
        
        #status {
            position: fixed; top: 20px; left: 20px;
            background: rgba(0,0,0,0.8); color: white; padding: 15px;
            border-radius: 10px; font-size: 14px; z-index: 999;
        }
    </style>
</head>
<body>
    <!-- Start Button for User Interaction -->
    <button id="start-ar">🎯 Start AR Experience</button>
    
    <!-- Status Display -->
    <div id="status">
        <div>📹 Camera: <span id="camera-status">Ready</span></div>
        <div>🎯 Tracking: <span id="tracking-status">Waiting</span></div>
        <div>🎬 Video: <span id="video-status">Ready</span></div>
    </div>
    
    <!-- AR Scene -->
    <a-scene
        id="ar-scene"
        vr-mode-ui="enabled: false"
        renderer="antialias: true; alpha: true;"
        embedded
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: true;"
        style="display: none;">
        
        <a-assets>
            {% if experience.video %}
            <video 
                id="ar-video" 
                src="{{ experience.video.url }}" 
                loop 
                muted 
                playsinline 
                webkit-playsinline 
                crossorigin="anonymous"
                preload="auto">
            </video>
            {% endif %}
        </a-assets>
        
        {% if marker_files_exist %}
        <!-- ✅ CRITICAL FIX: Add videohandler attribute -->
        <a-nft
            id="nft-marker"
            videohandler
            type="nft"
            url="{{ marker_base_url }}"
            smooth="true" 
            smoothCount="10" 
            smoothTolerance="0.01" 
            smoothThreshold="5">
            
            {% if experience.video %}
            <!-- ✅ CRITICAL FIX: Proper video scale and position -->
            <a-video 
                id="video-overlay"
                src="#ar-video" 
                position="0 0 0" 
                rotation="-90 0 0" 
                width="2" 
                height="2"
                opacity="0.95"
                visible="false">
            </a-video>
            {% endif %}
        </a-nft>
        {% endif %}
        
        <a-entity camera></a-entity>
    </a-scene>
    
    <script>
        let userInteracted = false;
        let arScene, marker, video, overlay;
        
        // ✅ CRITICAL FIX: Proper event handling
        function initAR() {
            arScene = document.getElementById('ar-scene');
            marker = document.getElementById('nft-marker');
            video = document.getElementById('ar-video');
            overlay = document.getElementById('video-overlay');
            
            console.log('🚀 AR initialized');
            document.getElementById('camera-status').textContent = 'Active';
            
            if (marker) {
                // ✅ CRITICAL FIX: Proper marker event listeners
                marker.addEventListener('markerFound', function() {
                    console.log('🎯 MARKER FOUND!');
                    document.getElementById('tracking-status').textContent = 'FOUND!';
                    
                    if (overlay) {
                        overlay.setAttribute('visible', 'true');
                        overlay.setAttribute('opacity', '0.95');
                    }
                    
                    if (video && userInteracted) {
                        video.play().then(() => {
                            console.log('✅ Video playing');
                            document.getElementById('video-status').textContent = 'Playing';
                        }).catch(error => {
                            console.log('❌ Video blocked:', error);
                            document.getElementById('video-status').textContent = 'Blocked - tap screen';
                        });
                    }
                });
                
                marker.addEventListener('markerLost', function() {
                    console.log('❌ Marker lost');
                    document.getElementById('tracking-status').textContent = 'Searching...';
                    
                    if (overlay) {
                        overlay.setAttribute('visible', 'false');
                    }
                    
                    if (video && !video.paused) {
                        video.pause();
                        document.getElementById('video-status').textContent = 'Paused';
                    }
                });
            }
            
            // ✅ CRITICAL FIX: Debug NFT file loading
            const markerUrl = "{{ marker_base_url }}";
            console.log('🔍 Testing NFT files at:', markerUrl);
            
            ['.fset', '.iset', '.fset3'].forEach(ext => {
                fetch(markerUrl + ext)
                    .then(r => console.log(`✅ ${ext}: ${r.status}`))
                    .catch(e => console.log(`❌ ${ext}: ${e.message}`));
            });
        }
        
        // ✅ CRITICAL FIX: User interaction handler
        document.getElementById('start-ar').addEventListener('click', function() {
            userInteracted = true;
            this.style.display = 'none';
            document.getElementById('ar-scene').style.display = 'block';
            
            // Enable video play for the session
            if (video) {
                video.muted = true; // Required for autoplay
            }
            
            setTimeout(initAR, 1000);
        });
        
        // ✅ CRITICAL FIX: Global click handler for video
        document.addEventListener('click', function() {
            if (video && video.paused && userInteracted) {
                video.play().catch(console.warn);
            }
        });
        
        // ✅ Debug functions
        window.testMarkerFiles = function() {
            const baseUrl = "{{ marker_base_url }}";
            console.log('Testing marker files at:', baseUrl);
            
            ['.fset', '.iset', '.fset3'].forEach(ext => {
                fetch(baseUrl + ext)
                    .then(response => {
                        if (response.ok) {
                            console.log(`✅ ${ext}: Found (${response.status})`);
                        } else {
                            console.log(`❌ ${ext}: Missing (${response.status})`);
                        }
                    })
                    .catch(error => {
                        console.log(`❌ ${ext}: Error - ${error.message}`);
                    });
            });
        };
        
        window.forceVideoPlay = function() {
            if (video) {
                video.play().then(() => {
                    console.log('✅ Video force-played');
                    if (overlay) {
                        overlay.setAttribute('visible', 'true');
                        overlay.setAttribute('opacity', '0.95');
                    }
                }).catch(error => {
                    console.log('❌ Video force-play failed:', error);
                });
            }
        };
        
        // Auto-test marker files after 3 seconds
        setTimeout(() => {
            if (typeof testMarkerFiles === 'function') {
                testMarkerFiles();
            }
        }, 3000);
    </script>
</body>
</html>
