{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
    <title>{{ title|default:experience.title }} - AR Experience</title>
    
    <!-- MindAR and A-Frame Libraries -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <script src="node_modules/mind-ar/dist/mindar-image-aframe.prod.js"></script>
    
    <!-- External CSS -->
    <link rel="stylesheet" href="{% static 'css/experience.css' %}">
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <div>ðŸŽ¥ Initializing AR Camera...</div>
        <div class="loading-subtitle">
            Grant camera permission when prompted
        </div>
    </div>
    
    <!-- Minimal Status Panel -->
    <div class="status-panel">
        <div class="status-item">
            <div class="status-dot" id="camera-dot"></div>
            Camera: <span id="camera-status">Starting...</span>
        </div>
        <div class="status-item">
            <div class="status-dot" id="tracking-dot"></div>
            Tracking: <span id="tracking-status">Initializing...</span>
        </div>
        {% if experience.video %}
        <div class="status-item">
            <div class="status-dot" id="video-dot"></div>
            Video: <span id="video-status">Ready</span>
        </div>
        {% endif %}
    </div>
    
    <!-- Instructions -->
    <div class="instructions">
        <div class="instruction-title">ðŸŽ¯ Point at Marker</div>
        <div class="instruction-text">Aim your camera at the marker image to see AR content</div>
    </div>
    
    <!-- MindAR Scene with Auto Camera Feed -->
    <a-scene
        id="ar-scene"
        mindar-image="
            imageTargetSrc: {{ marker_base_url }}.mind;
            autoStart: true;
            uiLoading: no;
            uiError: no;
            uiScanning: no;
            maxTrack: 1;
        "
        color-space="sRGB"
        renderer="antialias: true; alpha: true;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        background="transparent"
        embedded
    >
        <a-assets>
            {% if experience.video %}
            <video
                id="ar-video"
                src="{{ experience.video.url }}"
                loop muted playsinline webkit-playsinline
                crossorigin="anonymous"
                preload="auto"
                style="display: none;">
            </video>
            {% endif %}
            
            {% if experience.image %}
            <img id="marker-image" src="{{ experience.image.url }}" crossorigin="anonymous">
            {% endif %}
        </a-assets>
        
        <a-camera 
            position="0 0 0" 
            look-controls="enabled: false"
            wasd-controls="enabled: false">
        </a-camera>
        
        {% if marker_files_exist %}
        <a-entity mindar-image-target="targetIndex: 0" id="ar-target">
            {% if experience.video %}
            <a-video
                id="video-overlay"
                src="#ar-video"
                position="0 0 0.1"
                rotation="-90 0 0"
                width="1.6"
                height="0.9"
                opacity="0"
                visible="false">
            </a-video>
            {% else %}
            <!-- Fallback AR content -->
            <a-box
                position="0 0 0.1"
                rotation="-90 0 0"
                width="1.6" height="0.9" depth="0.01"
                color="#00ff88"
                opacity="0.8"
                material="transparent: true;">
            </a-box>
            <a-text
                value="{{ experience.title }}"
                position="0 0 0.12"
                rotation="-90 0 0"
                align="center"
                color="white"
                scale="0.6 0.6 0.6">
            </a-text>
            {% endif %}
        </a-entity>
        {% endif %}
    </a-scene>
    
    <!-- Pass Django variables to JavaScript -->
    <script>
        // Global configuration
        window.ARExperience = {
            slug: "{{ experience.slug }}",
            title: "{{ experience.title }}",
            markerUrl: "{{ marker_base_url }}.mind",
            videoUrl: "{% if experience.video %}{{ experience.video.url }}{% endif %}",
            imageUrl: "{% if experience.image %}{{ experience.image.url }}{% endif %}",
            websocketUrl: "{{ websocket_url|default:'' }}",
            debug: {% if debug %}true{% else %}false{% endif %},
            hasVideo: {% if experience.video %}true{% else %}false{% endif %},
            hasImage: {% if experience.image %}true{% else %}false{% endif %},
            markerExists: {% if marker_files_exist %}true{% else %}false{% endif %}
        };
        
        console.log('ðŸŽ¯ AR Experience Config:', window.ARExperience);
    </script>
    
    <!-- External JavaScript -->
    <script src="{% static 'js/experience.js' %}"></script>
</body>
</html>
