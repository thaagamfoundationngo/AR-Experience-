{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
    <title>{{ title|default:experience.title }} - MindAR Experience</title>
    
    <!-- MindAR Scripts -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        html, body {
            width: 100% !important;
            height: 100% !important;
            overflow: hidden !important;
            background: #000;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
        }
        
        /* Ensure MindAR scene fills entire viewport */
        #ar-scene {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 1 !important;
        }
        
        /* Force canvas to be visible and fill screen */
        #ar-scene canvas {
            width: 100% !important;
            height: 100% !important;
            display: block !important;
            visibility: visible !important;
        }
        
        /* Start Button */
        #start-ar {
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            padding: 20px 40px;
            border: none; 
            border-radius: 25px; 
            font-size: 18px; 
            font-weight: 600;
            cursor: pointer; 
            z-index: 1000;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }
        
        #start-ar:hover {
            transform: translate(-50%, -50%) scale(1.05);
        }
        
        /* Status Panel */
        #status {
            position: fixed; 
            top: 20px; 
            left: 20px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            color: white; 
            padding: 16px;
            border-radius: 12px; 
            font-size: 13px; 
            z-index: 999;
            min-width: 220px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 12px;
        }
        
        .ready { background: #10b981; }
        .active { background: #f59e0b; }
        .error { background: #ef4444; }
        
        /* Instructions */
        #instructions {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
            padding: 16px;
            border-radius: 12px;
            z-index: 999;
            font-size: 14px;
            display: none;
            max-width: 320px;
            backdrop-filter: blur(10px);
        }
        
        #instructions h4 {
            margin-bottom: 12px;
            color: #ffffff;
        }
        
        #instructions ul {
            list-style: none;
            padding: 0;
        }
        
        #instructions li {
            margin: 6px 0;
            padding-left: 16px;
            position: relative;
        }
        
        #instructions li::before {
            content: "‚Ä¢";
            color: #10b981;
            position: absolute;
            left: 0;
        }
        
        /* Marker Preview */
        #marker-preview {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 100px;
            height: 100px;
            border: 2px solid rgba(16, 185, 129, 0.8);
            border-radius: 12px;
            z-index: 998;
            object-fit: cover;
        }
        
        /* Loading */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            flex-direction: column;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Error Panel */
        #error-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(239, 68, 68, 0.95);
            color: white;
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            z-index: 1002;
            display: none;
            max-width: 400px;
        }
        
        .error-button {
            background: white;
            color: #ef4444;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            margin: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            #status {
                top: 10px;
                left: 10px;
                right: 10px;
                min-width: auto;
                font-size: 12px;
            }
            
            #instructions {
                bottom: 10px;
                left: 10px;
                right: 10px;
                max-width: none;
                font-size: 13px;
            }
            
            #marker-preview {
                width: 80px;
                height: 80px;
            }
        }
    </style>
</head>
<body>
    <!-- Start Button -->
    <button id="start-ar">üöÄ Start AR Experience</button>
    
    <!-- Loading -->
    <div id="loading">
        <div class="loading-spinner"></div>
        <h2>Initializing MindAR...</h2>
        <p>Setting up camera and AR tracking</p>
    </div>
    
    <!-- Error Panel -->
    <div id="error-panel">
        <h3>‚ö†Ô∏è AR Setup Error</h3>
        <p id="error-message">Something went wrong with the AR initialization.</p>
        <div>
            <button class="error-button" onclick="location.reload()">Reload Page</button>
            <button class="error-button" onclick="window.history.back()">Go Back</button>
        </div>
    </div>
    
    <!-- Status Panel -->
    <div id="status">
        <div class="status-item">
            <span class="status-dot ready"></span>
            <span>üìπ Camera: <strong id="camera-status">Ready</strong></span>
        </div>
        <div class="status-item">
            <span class="status-dot ready"></span>
            <span>üß† MindAR: <strong id="mindar-status">Ready</strong></span>
        </div>
        <div class="status-item">
            <span class="status-dot ready"></span>
            <span>üéØ Target: <strong id="target-status">Checking...</strong></span>
        </div>
        <div class="status-item">
            <span class="status-dot ready"></span>
            <span>üé¨ Video: <strong id="video-status">Ready</strong></span>
        </div>
    </div>
    
    <!-- Instructions -->
    <div id="instructions">
        <h4>üì± AR Detection Guide</h4>
        <ul>
            <li>Hold marker 20-40cm from camera</li>
            <li>Ensure good, even lighting</li>
            <li>Keep marker flat and fully visible</li>
            <li>Wait for the green tracking indicator</li>
            <li>Move slowly for better tracking</li>
        </ul>
    </div>
    
    <!-- Marker Preview -->
    <img id="marker-preview" src="{{ marker_image_url }}" alt="AR Marker">
    
    <!-- MindAR Scene -->
    <a-scene
        id="ar-scene"
        mindar-image="imageTargetSrc: {{ marker_base_url }}.mind; 
                    maxTrack: 1; 
                    filterMinCF: 0.0001; 
                    filterBeta: 0.001;
                    warmupTolerance: 2; 
                    missTolerance: 5; 
                    autoStart: false;
                    showStats: false; 
                    uiLoading: no; 
                    uiError: no; 
                    uiScanning: no;"
        style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; display: none;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        renderer="colorManagement: true; physicallyCorrectLights: true;"
        background="transparent">
        
        <a-assets>
            {% if video_url %}
            <video 
                id="ar-video" 
                src="{{ video_url }}" 
                loop 
                muted 
                playsinline 
                webkit-playsinline 
                crossorigin="anonymous"
                preload="auto"
                style="display: none;">
            </video>
            {% endif %}
        </a-assets>
        
        <!-- Camera -->
        <a-camera 
            position="0 0 0" 
            look-controls="enabled: false"
            cursor="rayOrigin: mouse">
        </a-camera>
        
        <!-- AR Content -->
        <a-entity id="target-content" mindar-image-target="targetIndex: 0">
            {% if video_url %}
            <!-- Video Overlay -->
            <a-video 
                id="video-overlay"
                src="#ar-video" 
                position="0 0 0.01" 
                rotation="0 0 0" 
                width="1.2" 
                height="0.8"
                visible="false">
            </a-video>
            {% endif %}
            
            <!-- Detection Border -->
            <a-plane 
                id="detection-border"
                position="0 0 0" 
                rotation="0 0 0" 
                width="1.3" 
                height="0.9"
                opacity="0.1"
                color="#10b981"
                visible="false"
                material="transparent: true;">
            </a-plane>
            
            <!-- Title -->
            <a-text 
                value="{{ experience.title }}"
                position="0 -0.5 0.02"
                align="center"
                color="#ffffff"
                width="3"
                visible="false">
            </a-text>
        </a-entity>
    </a-scene>

<script>
//=============================================================================
// MINDAR AR EXPERIENCE - CLEAN IMPLEMENTATION
//=============================================================================

// Global State
const ARState = {
    userInteracted: false,
    cameraGranted: false,
    mindArReady: false,
    targetFound: false,
    arStarted: false,
    videoPlaying: false
};

// DOM Elements
const Elements = {};

//=============================================================================
// INITIALIZATION
//=============================================================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ MindAR AR Experience Starting...');
    console.log('=== DEBUG INFO ===');
    console.log('Marker base URL:', "{{ marker_base_url }}");
    console.log('Target file URL:', "{{ marker_base_url }}.mind");
    console.log('Marker image URL:', "{{ marker_image_url }}");
    console.log('Video URL:', "{{ video_url }}");
    console.log('=================');
    
    // Initialize
    cacheElements();
    setupEventListeners();
    checkTargetFile();
    
    console.log('‚úÖ AR Experience initialized');
});

function cacheElements() {
    const elementIds = [
        'start-ar', 'loading', 'ar-scene', 'ar-video', 
        'video-overlay', 'instructions', 'error-panel', 
        'marker-preview', 'detection-border',
        'camera-status', 'mindar-status', 'target-status', 'video-status'
    ];
    
    elementIds.forEach(id => {
        Elements[id] = document.getElementById(id);
    });
}

function setupEventListeners() {
    Elements['start-ar']?.addEventListener('click', startARExperience);
    
    // User interaction tracking
    ['click', 'touchstart'].forEach(event => {
        document.addEventListener(event, () => {
            ARState.userInteracted = true;
        }, { once: true });
    });
}

//=============================================================================
// AR EXPERIENCE FLOW
//=============================================================================

async function startARExperience() {
    if (ARState.arStarted) return;
    
    try {
        ARState.userInteracted = true;
        
        // Show loading
        Elements['start-ar'].style.display = 'none';
        Elements['loading'].style.display = 'flex';
        updateStatus('camera-status', 'Starting...', 'active');
        
        // Request camera permission
        await requestCameraPermission();
        
        // Initialize AR
        await initializeMindAR();
        
    } catch (error) {
        console.error('‚ùå Failed to start AR experience:', error);
        showError('Failed to start AR experience: ' + error.message);
    }
}

async function requestCameraPermission() {
    try {
        updateStatus('camera-status', 'Requesting...', 'active');
        
        // Request camera with specific constraints
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: { ideal: 1280 },
                height: { ideal: 720 },
                facingMode: 'environment' // Back camera on mobile
            } 
        });
        
        console.log('‚úÖ Camera permission granted');
        updateStatus('camera-status', 'Granted', 'ready');
        
        // Stop test stream (MindAR will handle the actual stream)
        stream.getTracks().forEach(track => track.stop());
        ARState.cameraGranted = true;
        
    } catch (error) {
        console.error('‚ùå Camera permission denied:', error);
        updateStatus('camera-status', 'Denied', 'error');
        
        let errorMsg = 'Camera access denied. ';
        if (error.name === 'NotFoundError') {
            errorMsg += 'No camera found on this device.';
        } else if (error.name === 'NotAllowedError') {
            errorMsg += 'Please allow camera access and reload the page.';
        } else if (error.name === 'NotReadableError') {
            errorMsg += 'Camera is being used by another application.';
        }
        
        throw new Error(errorMsg);
    }
}

async function initializeMindAR() {
    console.log('üß† Initializing MindAR system...');
    updateStatus('mindar-status', 'Starting...', 'active');
    
    try {
        // Setup video element
        setupVideoElement();
        
        // Setup MindAR events
        setupMindAREvents();
        
        // Show AR scene
        Elements['loading'].style.display = 'none';
        Elements['ar-scene'].style.display = 'block';
        Elements['instructions'].style.display = 'block';
        
        // Start AR scene
        await startARScene();
        
    } catch (error) {
        console.error('‚ùå MindAR initialization failed:', error);
        throw error;
    }
}

function setupVideoElement() {
    if (!Elements['ar-video']) return;
    
    const video = Elements['ar-video'];
    video.muted = true;
    video.playsInline = true;
    video.autoplay = false; // Control manually
    video.loop = true;
    
    // Video event listeners
    video.addEventListener('loadeddata', () => {
        console.log('üìπ Video data loaded');
        updateStatus('video-status', 'Loaded', 'ready');
    });
    
    video.addEventListener('play', () => {
        console.log('‚ñ∂Ô∏è Video playing');
        ARState.videoPlaying = true;
        updateStatus('video-status', 'Playing', 'active');
    });
    
    video.addEventListener('pause', () => {
        console.log('‚è∏Ô∏è Video paused');
        ARState.videoPlaying = false;
        updateStatus('video-status', 'Paused', 'ready');
    });
    
    video.load();
}

async function startARScene() {
    console.log('üöÄ Starting AR scene...');
    
    try {
        const scene = Elements['ar-scene'];
        
        if (scene.hasLoaded) {
            await initializeARSystem();
        } else {
            scene.addEventListener('loaded', initializeARSystem);
        }
        
    } catch (error) {
        console.error('‚ùå Failed to start AR scene:', error);
        throw error;
    }
}

async function initializeARSystem() {
    try {
        console.log('üîß Starting MindAR system...');
        
        const scene = Elements['ar-scene'];
        const arSystem = scene.systems['mindar-image-system'];
        
        if (arSystem) {
            await arSystem.start();
            ARState.arStarted = true;
            updateStatus('camera-status', 'Active', 'ready');
            updateStatus('mindar-status', 'Active', 'ready');
            console.log('‚úÖ AR system started - camera feed should be visible');
            
            // Force scene visibility
            scene.style.display = 'block';
            scene.style.visibility = 'visible';
            
        } else {
            throw new Error('MindAR system not found');
        }
        
    } catch (error) {
        console.error('‚ùå AR system failed:', error);
        showError('AR system failed to start. Check camera permissions and marker file.');
        throw error;
    }
}

//=============================================================================
// MINDAR EVENT HANDLING
//=============================================================================

function setupMindAREvents() {
    const scene = Elements['ar-scene'];
    
    // System ready
    scene.addEventListener('renderstart', () => {
        ARState.mindArReady = true;
        console.log('‚úÖ MindAR rendering started - camera feed is now active');
        updateStatus('mindar-status', 'Tracking', 'ready');
    });
    
    // Target detection
    scene.addEventListener('targetFound', (e) => {
        ARState.targetFound = true;
        console.log('üéØ Target detected!');
        updateStatus('target-status', 'DETECTED!', 'active');
        
        // Show AR content
        showARContent();
        
        // Play video
        if (ARState.userInteracted && Elements['ar-video']) {
            playVideo();
        }
        
        Elements['instructions'].style.display = 'none';
    });
    
    scene.addEventListener('targetLost', (e) => {
        ARState.targetFound = false;
        console.log('‚ö†Ô∏è Target lost');
        updateStatus('target-status', 'Searching...', 'ready');
        
        // Hide AR content
        hideARContent();
        
        // Pause video
        if (Elements['ar-video']) {
            Elements['ar-video'].pause();
        }
        
        Elements['instructions'].style.display = 'block';
    });
    
    scene.addEventListener('arError', (e) => {
        console.error('üö® MindAR Error:', e.detail);
        updateStatus('mindar-status', 'Error', 'error');
        showError('MindAR tracking error: ' + e.detail);
    });
}

//=============================================================================
// AR CONTENT MANAGEMENT
//=============================================================================

function showARContent() {
    const elements = ['video-overlay', 'detection-border'];
    
    elements.forEach(id => {
        const element = Elements[id];
        if (element) {
            element.setAttribute('visible', 'true');
        }
    });
    
    // Show title text
    const titleElement = document.querySelector('a-text');
    if (titleElement) {
        titleElement.setAttribute('visible', 'true');
    }
}

function hideARContent() {
    const elements = ['video-overlay', 'detection-border'];
    
    elements.forEach(id => {
        const element = Elements[id];
        if (element) {
            element.setAttribute('visible', 'false');
        }
    });
    
    // Hide title text
    const titleElement = document.querySelector('a-text');
    if (titleElement) {
        titleElement.setAttribute('visible', 'false');
    }
}

//=============================================================================
// VIDEO PLAYBACK
//=============================================================================

function playVideo() {
    if (!Elements['ar-video']) return;
    
    Elements['ar-video'].play().then(() => {
        console.log('‚úÖ Video playing automatically');
    }).catch((error) => {
        console.log('‚ö†Ô∏è Video autoplay failed:', error);
        // Could add manual play button here if needed
    });
}

//=============================================================================
// TARGET FILE VALIDATION
//=============================================================================

async function checkTargetFile() {
    const targetUrl = "{{ marker_base_url }}.mind";
    
    if (!targetUrl || targetUrl.includes('undefined') || targetUrl.includes('None')) {
        updateStatus('target-status', 'Invalid Path', 'error');
        return;
    }
    
    try {
        const response = await fetch(targetUrl, { method: 'HEAD' });
        
        if (response.ok) {
            const size = response.headers.get('content-length');
            console.log(`‚úÖ Target file found (${size} bytes)`);
            
            if (size && parseInt(size) < 1000) {
                updateStatus('target-status', 'File Small', 'error');
                showError(`Marker file is too small (${size} bytes). Please regenerate it.`);
            } else {
                updateStatus('target-status', 'File Ready', 'ready');
            }
        } else {
            updateStatus('target-status', 'File Missing', 'error');
            showError(`Marker file not found (HTTP ${response.status})`);
        }
    } catch (error) {
        console.error('‚ùå Target file check failed:', error);
        updateStatus('target-status', 'Check Failed', 'error');
        showError('Failed to check marker file: ' + error.message);
    }
}

//=============================================================================
// UTILITY FUNCTIONS
//=============================================================================

function updateStatus(statusId, text, statusClass) {
    const element = Elements[statusId];
    if (element) {
        element.textContent = text;
        const statusItem = element.closest('.status-item');
        const dot = statusItem?.querySelector('.status-dot');
        if (dot) {
            dot.className = `status-dot ${statusClass}`;
        }
    }
}

function showError(message) {
    const errorPanel = Elements['error-panel'];
    const errorMessage = document.getElementById('error-message');
    
    if (errorPanel && errorMessage) {
        errorMessage.textContent = message;
        errorPanel.style.display = 'block';
    }
    
    console.error('üö® Error:', message);
}

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

console.log('üß† Clean MindAR Experience Ready');
</script>
</body>
</html>
