{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <title>{{ title|default:experience.title }}</title>

  <!-- Preloading scripts to prevent caching and ensure reloading -->
  <script src="{% static 'arexp/aframe.min.js' %}?v={{ timestamp }}"></script>
  <script src="{% static 'arexp/aframe-ar-nft.js' %}?v={{ timestamp }}"></script>
  <script src="{% static 'arexp/ar-threex.js' %}?v={{ timestamp }}"></script>

  <style>
    html, body {
      margin: 0;
      overflow: hidden;
      background: #000;
      font-family: Arial, sans-serif;
    }

    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      color: white;
      transition: opacity 0.5s;
    }

    #loading.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .spinner {
      border: 3px solid #333;
      border-top: 3px solid #00ff00;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #status {
      position: fixed;
      top: 20px;
      left: 20px;
      color: white;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px;
      border-radius: 8px;
      font-size: 12px;
      z-index: 999;
      max-width: 280px;
      line-height: 1.4;
    }

    #instructions {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px 20px;
      border-radius: 12px;
      text-align: center;
      font-size: 14px;
      z-index: 999;
      transition: opacity 0.3s;
      max-width: 300px;
    }

    #instructions.hidden {
      opacity: 0;
    }

    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 5px;
    }

    .status-ready { background: #00ff00; }
    .status-searching { background: #ff9500; animation: pulse 1s infinite; }
    .status-tracking { background: #0099ff; }
    .status-error { background: #ff0000; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading">
    <div class="spinner"></div>
    <div id="loading-text">Initializing AR Camera...</div>
    <div style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
      Please allow camera access
    </div>
  </div>
  
  <!-- Status Display -->
  <div id="status">
    <div><span class="status-indicator status-ready" id="camera-indicator"></span><strong>Camera:</strong> <span id="camera-status">Loading...</span></div>
    <div><span class="status-indicator status-searching" id="tracking-indicator"></span><strong>Tracking:</strong> <span id="tracking-status">Searching...</span></div>
    <div><span class="status-indicator status-ready" id="video-indicator"></span><strong>Video:</strong> <span id="video-status">Ready</span></div>
  </div>
  
  <!-- Instructions -->
  <div id="instructions">
    <div style="font-size: 16px; margin-bottom: 8px;">ðŸ“± <strong>Point at the image</strong></div>
    <div>Keep the marker clearly visible and steady.<br>Video will auto-play when detected.</div>
  </div>

  <a-scene
    id="ar-scene"
    vr-mode-ui="enabled:false"
    renderer="antialias:true;alpha:true;precision:mediump;colorManagement:true"
    embedded
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled:false; detectionMode: mono; matrixCodeType: 3x3;"
  >
    <a-assets>
      {% if experience.video %}
      <video 
        id="clip" 
        src="{{ experience.video.url }}" 
        loop 
        muted 
        playsinline 
        webkit-playsinline 
        crossorigin="anonymous"
        preload="metadata">
      </video>
      {% endif %}
    </a-assets>

    {% if marker_files_exist %}
    <a-nft
      id="nft-marker"
      type="nft"
      url="{{ marker_base_url }}"
      smooth="true" 
      smoothCount="10" 
      smoothTolerance="0.01" 
      smoothThreshold="5"
    >
      {% if experience.video %}
      <!-- Enhanced Video Plane with Frame -->
      <a-video 
        id="video-plane"
        src="#clip" 
        position="0 0 0.01" 
        rotation="-90 0 0" 
        width="1.6" 
        height="0.9"
        opacity="0.95"
        visible="true">
      </a-video>
      
      <!-- Video Frame -->
      <a-box 
        position="0 0 0" 
        rotation="-90 0 0" 
        depth="0.005" 
        width="1.65" 
        height="0.95" 
        color="#222"
        opacity="0.8">
      </a-box>
      
      {% else %}
      <!-- Fallback when no video -->
      <a-box 
        position="0 0 0" 
        rotation="-90 0 0" 
        depth="0.01" 
        width="1.6" 
        height="0.9" 
        color="#0099ff"
        opacity="0.8">
      </a-box>
      
      <a-text 
        value="AR Content Ready" 
        position="0 0 0.02" 
        rotation="-90 0 0" 
        align="center" 
        color="#fff"
        scale="0.5 0.5 0.5">
      </a-text>
      {% endif %}
    </a-nft>
    {% else %}
    <!-- Error state -->
    <a-entity position="0 0 -1">
      <a-text 
        value="Marker files missing or invalid" 
        color="#ff4444" 
        align="center"
        scale="0.8 0.8 0.8">
      </a-text>
    </a-entity>
    {% endif %}

    <a-entity camera look-controls-enabled="false" arjs-look-controls="smoothingFactor: 0.1"></a-entity>
  </a-scene>

  <script>
    // Enhanced AR Video Controller
    class ARController {
      constructor() {
        this.isTracking = false;
        this.videoLoaded = false;
        this.trackingCount = 0;
        this.minTrackingFrames = 3; // Stability threshold
        
        this.initElements();
        this.setupEventListeners();
        this.initializeAR();
      }
      
      initElements() {
        this.scene = document.getElementById('ar-scene');
        this.nftMarker = document.getElementById('nft-marker');
        this.video = document.getElementById('clip');
        this.videoPlane = document.getElementById('video-plane');
        
        // UI elements
        this.loadingEl = document.getElementById('loading');
        this.instructionsEl = document.getElementById('instructions');
        this.cameraStatus = document.getElementById('camera-status');
        this.trackingStatus = document.getElementById('tracking-status');
        this.videoStatus = document.getElementById('video-status');
        this.cameraIndicator = document.getElementById('camera-indicator');
        this.trackingIndicator = document.getElementById('tracking-indicator');
        this.videoIndicator = document.getElementById('video-indicator');
      }
      
      setupEventListeners() {
        // AR.js marker events
        if (this.nftMarker) {
          this.nftMarker.addEventListener('markerFound', () => this.onMarkerFound());
          this.nftMarker.addEventListener('markerLost', () => this.onMarkerLost());
        }
        
        // Video events
        if (this.video) {
          this.video.addEventListener('loadeddata', () => this.onVideoLoaded());
          this.video.addEventListener('canplay', () => this.onVideoCanPlay());
          this.video.addEventListener('play', () => this.onVideoPlay());
          this.video.addEventListener('pause', () => this.onVideoPause());
          this.video.addEventListener('error', (e) => this.onVideoError(e));
          
          // Preload video
          this.video.load();
        }
        
        // Scene ready
        if (this.scene) {
          this.scene.addEventListener('loaded', () => this.onSceneLoaded());
          this.scene.addEventListener('arjs-video-loaded', () => this.onCameraReady());
        }
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
          if (document.hidden && this.video && !this.video.paused) {
            this.video.pause();
          }
        });
      }
      
      initializeAR() {
        // Hide loading after a timeout as fallback
        setTimeout(() => {
          if (this.loadingEl && !this.loadingEl.classList.contains('hidden')) {
            this.hideLoading();
          }
        }, 8000);
      }
      
      onSceneLoaded() {
        console.log('AR Scene loaded');
        this.updateStatus('camera', 'Initializing camera...', 'searching');
      }
      
      onCameraReady() {
        console.log('Camera ready');
        this.updateStatus('camera', 'Ready', 'ready');
        this.hideLoading();
      }
      
      onVideoLoaded() {
        console.log('Video loaded');
        this.videoLoaded = true;
        this.updateStatus('video', 'Loaded', 'ready');
      }
      
      onVideoCanPlay() {
        console.log('Video can play');
        this.updateStatus('video', 'Ready to play', 'ready');
      }
      
      onVideoPlay() {
        console.log('Video started playing');
        this.updateStatus('video', 'Playing', 'tracking');
        if (this.instructionsEl) {
          this.instructionsEl.classList.add('hidden');
        }
      }
      
      onVideoPause() {
        console.log('Video paused');
        this.updateStatus('video', 'Paused', 'ready');
      }
      
      onVideoError(error) {
        console.error('Video error:', error);
        this.updateStatus('video', 'Error loading video', 'error');
      }
      
      onMarkerFound() {
        console.log('Marker found');
        this.trackingCount++;
        
        if (this.trackingCount >= this.minTrackingFrames && !this.isTracking) {
          this.isTracking = true;
          this.updateStatus('tracking', 'Tracking active', 'tracking');
          
          // Auto-play video with error handling
          if (this.video && this.videoLoaded) {
            this.video.play()
              .then(() => {
                console.log('Video auto-play successful');
              })
              .catch(error => {
                console.warn('Auto-play failed, user interaction required:', error);
                this.updateStatus('video', 'Tap to play', 'ready');
                
                // Add click handler for manual play
                this.addPlayClickHandler();
              });
          }
        }
      }
      
      onMarkerLost() {
        console.log('Marker lost');
        this.trackingCount = Math.max(0, this.trackingCount - 2);
        
        if (this.trackingCount === 0 && this.isTracking) {
          this.isTracking = false;
          this.updateStatus('tracking', 'Searching...', 'searching');
          
          if (this.instructionsEl) {
            this.instructionsEl.classList.remove('hidden');
          }
          
          // Pause video when marker is lost
          if (this.video && !this.video.paused) {
            this.video.pause();
          }
        }
      }
      
      addPlayClickHandler() {
        const clickHandler = () => {
          if (this.video && this.isTracking) {
            this.video.play().catch(console.error);
            document.removeEventListener('click', clickHandler);
            document.removeEventListener('touchstart', clickHandler);
          }
        };
        
        document.addEventListener('click', clickHandler);
        document.addEventListener('touchstart', clickHandler);
      }
      
      updateStatus(type, message, status) {
        const statusEl = this[`${type}Status`];
        const indicatorEl = this[`${type}Indicator`];
        
        if (statusEl) statusEl.textContent = message;
        if (indicatorEl) {
          indicatorEl.className = `status-indicator status-${status}`;
        }
      }
      
      hideLoading() {
        if (this.loadingEl) {
          this.loadingEl.classList.add('hidden');
        }
      }
    }
    
    // Initialize AR Controller when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => new ARController());
    } else {
      new ARController();
    }
  </script>
</body>
</html>
